{% extends 'master/panel_dashboard.html' %}
{% load custom_tags %}
{% load news_tags %}
{% load static %}
{% block settings_tab_name %}
<title>{{settings.tab_name}} | دسته بندی</title>
{% endblock settings_tab_name %} 
{% block quill_css %}
<link rel="stylesheet" type="text/css" href="{% static 'master/' %}vendor/quill/css/quill.snow.css">
{% endblock quill_css %}
{% block contentpanel_dashboard %}

  <!-- =======================
Main contain START -->

<!-- List Show Category START -->
<section class="py-4">
    <div class="container">
        <div class="row pb-4">
            <div class="col-12">
                <!-- Title -->
                <div class="d-sm-flex justify-content-sm-between align-items-center">
                    <h1 class="mb-2 mb-sm-0 h3">لیست دسته ها </h1>          
                    <button type="button" class="btn btn-sm btn-primary mb-0" data-bs-toggle="modal" data-bs-target="#modal_category">
                        ثبت دسته بندی جدید
                    </button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <!-- Post list table START -->
                <div class="card border bg-transparent rounded-3">
                    <!-- Card body START -->
                    <div class="card-body p-3">
                        <div class="row g-3 align-items-center justify-content-between mb-3">
                            <div class="col-md-8">
                                <form id="category-search-form" class="rounded position-relative" method="GET" action="{% url 'master_category_create' %}">
                                    <input id="category-search-input" class="form-control pe-5 bg-transparent" type="search" name="category_search" placeholder="جستجو" aria-label="Search">
                                    <button class="btn bg-transparent border-0 px-2 py-0 position-absolute top-50 end-0 translate-middle-y" type="submit"><i class="fas fa-search fs-6 "></i></button>
                                </form>
                            </div>
                        </div>
                        <!-- Post list table START -->
                        <div class="table-responsive border-0">
                            <table class="table align-middle p-4 mb-0 table-hover table-shrink">
                                <!-- Table head -->
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col" class="border-0 rounded-start">عنوان</th>
                                        <th scope="col" class="border-0">تعداد خبر</th>
                                        <th scope="col" class="border-0 rounded-end">فعالیت</th>
                                    </tr>
                                </thead>
                                <!-- Table body START -->
                                <tbody id="category-table-body" class="border-top-0">
                                    {% include 'master/includes/category_list_table.html' %}
                                </tbody>
                                <!-- Table body END -->
                            </table>
                        </div>
                        <!-- Post list table END -->
                        <!-- Pagination START -->
                        <div class="d-sm-flex justify-content-sm-between align-items-sm-center mt-4 mt-sm-3">
                            <p id="category-item-count" class="mb-sm-0 text-center text-sm-start">
                                نمایش {{ show_list_category.start_index }} تا {{ show_list_category.end_index }} از {{ show_list_category.paginator.count }}
                            </p>
                            <nav id="category-pagination" class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
                                {% include 'master/includes/category_pagination.html' %}
                            </nav>
                        </div>
                        <!-- Pagination END -->
                    </div>
                </div>
                <!-- Post list table END -->
            </div>
        </div>
    </div>
</section>
<!-- List Show Category END -->

<!-- List Show Sub Category START -->
<section class="py-4">
    <div class="container">
        <div class="row pb-4">
            <div class="col-12">
                <!-- Title -->
                <div class="d-sm-flex justify-content-sm-between align-items-center">
                    <h1 class="mb-2 mb-sm-0 h3">لیست زیرمجموعه ها </h1>        
                    <button type="button" class="btn btn-sm btn-primary mb-0" data-bs-toggle="modal" data-bs-target="#modal_sub_category_add">
                        ثبت زیرمجموعه جدید
                    </button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <!-- Post list table START -->
                <div class="card border bg-transparent rounded-3">
                    <!-- Card body START -->
                    <div class="card-body p-3">
                        <div class="row g-3 align-items-center justify-content-between mb-3">
                            <div class="col-md-8">
                                <form id="subcategory-search-form" class="rounded position-relative" method="GET" action="{% url 'master_category_create' %}">
                                    <input id="subcategory-search-input" class="form-control pe-5 bg-transparent" type="search" name="subcategory_search" placeholder="جستجو" aria-label="Search">
                                    <button class="btn bg-transparent border-0 px-2 py-0 position-absolute top-50 end-0 translate-middle-y" type="submit"><i class="fas fa-search fs-6 "></i></button>
                                </form>
                            </div>
                        </div>
                        <!-- Post list table START -->
                        <div class="table-responsive border-0">
                            <table class="table align-middle p-4 mb-0 table-hover table-shrink">
                                <!-- Table head -->
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col" class="border-0 rounded-start">عنوان</th>
                                        <th scope="col" class="border-0">دسته بندی</th>
                                        <th scope="col" class="border-0 rounded-end">فعالیت</th>
                                    </tr>
                                </thead>
                                <!-- Table body START -->
                                <tbody id="sub-category-table-body" class="border-top-0">
                                    {% include 'master/includes/sub_category_list_table.html' %}
                                </tbody>
                                <!-- Table body END -->
                            </table>
                        </div>
                        <!-- Post list table END -->
                        <!-- Pagination START -->
                        <div class="d-sm-flex justify-content-sm-between align-items-sm-center mt-4 mt-sm-3">
                            <p id="subcategory-item-count" class="mb-sm-0 text-center text-sm-start">
                                نمایش {{ show_list_sub_category.start_index }} تا {{ show_list_sub_category.end_index }} از {{ show_list_sub_category.paginator.count }}
                            </p>
                            <nav id="subcategory-pagination" class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
                                {% include 'master/includes/sub_category_pagination.html' %}
                            </nav>
                        </div>
                        <!-- Pagination END -->
                    </div>
                </div>
                <!-- Post list table END -->
            </div>
        </div>
    </div>
</section>
<!-- List Show Sub Category END -->


<!-- Modal Add Category -->
<div class="modal fade" id="modal_category" tabindex="-1" aria-labelledby="modal_category_lLabel" aria-hidden="true">
	<div class="modal-dialog">
	<div class="modal-content">
		<div class="modal-header">
		<h5 class="modal-title" id="modal_category_lLabel">ایجاد دسته بندی</h5>
		<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
		<form action="{% url 'master_category_create_submit' %}" method="POST" enctype="multipart/form-data" id="form_all">
		{% csrf_token %}
		<div class="modal-body">
			<div class="col-12">
				<div class="mb-3">
				  <label class="form-label">عنوان</label>
				  <input required id="title_category" name="title_category" type="text" class="form-control" placeholder="عنوان دسته بندی">
				  </div>
			  </div>
			  <div class="row">
				<div class="col-6">
					<div class="mb-3">
						<label class="form-label">رنگ پس زمینه</label>
						<input id="color_bg_category" name="color_bg_category" type="color" class="form-control" value="#f5f5f5" placeholder="حالت پیشفرض #f5f5f5">
					</div>
				</div>
				<div class="col-6">
					<div class="mb-3">
						<label class="form-label">رنگ متن</label>
						<input id="color_text_category" name="color_text_category" type="color" class="form-control" value="#333" placeholder="حالت پیشفرض #333">
					</div>
				</div>
			</div>
			<div class="col-12">
				<div class="mb-3">
				<!-- Image -->
				<div class="position-relative">
					<h6 class="my-2">آپلود تصویر شاخص</h6>
					<label class="w-100" style="cursor:pointer;">
						<div class="input-group flex-row-reverse">
							<input type="text" class="form-control upload-name" id="upload-name-create"/>
							<span class="btn btn-custom cursor-pointer upload-button" id="upload-button-create">آپلود فایل</span>
						</div>
						<input class="form-control stretched-link d-none hidden-upload" type="file" id="img_category_create" name="img_category" accept="image/gif, image/jpeg, image/png, image/webp"/>
					</label>
				</div>
			</div>		
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
		<button type="submit" class="btn btn-primary">ایجاد دسته بندی</button>
	</div>
	</div>
	</form>
		</div>
	</div>
</div>



<!-- Modal Add SUB Category -->
<div class="modal fade" id="modal_sub_category_add" tabindex="-1" aria-labelledby="modal_sub_category_lLabel" aria-hidden="true">
	<div class="modal-dialog">
	<div class="modal-content">
		<div class="modal-header">
		<h5 class="modal-title" id="modal_category_lLabel">ایجاد دسته بندی</h5>
		<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
		<form action="{% url 'master_sub_category_create_submit' %}" id="sub_cat_add" method="POST" enctype="multipart/form-data">
			{% csrf_token %}
		<div class="modal-body">
			<div class="row">
			<div class="col-6">
				<div class="mb-3">
					<label class="form-label">عنوان</label>
					<input required id="title_subcategory_add" name="title_subcategory_add" type="text" class="form-control" placeholder="عنوان زیر دسته بندی">
				</div>
			</div>
			<div class="col-6">
				<div class="mb-3">
					<label class="form-label">انتخاب دسته اصلی</label>
					<select class="form-select" id="category_add_show" name="category_add_show" aria-label="Default select example">
						<option value="" selected>دسته خبر را انتخاب کنید</option>
						{% for i in show_add_category %}
						<option value="{{i.id}}">{{i.title}}</option>
						{% endfor %}
					  </select></div>
			</div>
		</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
					<button type="submit" class="btn btn-primary">ایجاد</button>
				</div>
			</div>
			
		</form>
		</div>
	</div>
</div>


<!-- =======================
Main contain END -->
<!-- Button trigger modal -->
{% for i in show_list_category %}
<!-- Modal -->
<div class="modal fade" id="modal_category_edit_{{i.id}}" tabindex="-1" aria-labelledby="modal_category_lLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="modal_category_lLabel">ویرایش دسته بندی</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<form action="{% url 'master_category_edit_submit' id=i.id %}" id="form_category_edit" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
			<div class="modal-body">
				<div class="col-12">
					<div class="mb-3">
						<label class="form-label">ویرایش عنوان</label>
						<input required id="title_category_edit" name="title_category_edit" type="text" class="form-control" value="{{i.title}}" placeholder="عنوان دسته بندی">
					</div>
				</div>
					<div class="row">
						<div class="col-6">
							<div class="mb-3">
								<label class="form-label">ویرایش رنگ پس زمینه</label>
								<input id="color_bg_category_edit" name="color_bg_category_edit" type="color" class="form-control" value="{{i.color}}" placeholder="حالت پیشفرض #f5f5f5">
							</div>
						</div>
						<div class="col-6">
							<div class="mb-3">
								<label class="form-label">ویرایش رنگ متن</label>
								<input id="color_text_category_edit" name="color_text_category_edit" type="color" class="form-control" value="{{i.color_text}}" placeholder="حالت پیشفرض #333">
							</div>
						</div>
					</div>
						<div class="col-12">
							<div class="mb-3">
							<!-- Image -->
							<div class="position-relative">
								<h6 class="my-2">ویرایش تصویر شاخص</h6>
								<label class="w-100" style="cursor:pointer;">
									<input class="form-control" type="file" id="img_category_edit" name="img_category_edit" accept="image/gif, image/jpeg, image/png, image/webp"/></label>
							</div>
						</div>		
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
						<button type="submit" class="btn btn-primary">ویرایش دسته بندی</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
{% endfor %}






<!-- Button trigger modal -->
{% for i in show_list_category %}
<!-- Modal -->
<div class="modal fade" id="modal_sub_category_edit" tabindex="-1" aria-labelledby="modal_sub_category_lLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="modal_sub_category_lLabel">ریز دسته بندی</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<form action="{% url 'master_category_edit_submit' id=i.id %}" id="form_category_edit" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
			<div class="modal-body">
				<div class="col-6">
					<div class="mb-3">
						<label class="form-label">عنوان</label>
						<input required id="title_subcategory_add" name="title_subcategory_add" type="text" class="form-control" placeholder="عنوان زیر دسته بندی">
					</div>
				</div>
				<div class="col-6">
					<div class="mb-3">
						<label class="form-label">عنوان</label>
						<input required id="title_subcategory_add" name="title_subcategory_add" type="text" class="form-control" placeholder="عنوان زیر دسته بندی">
					</div>
				</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
						<button type="submit" class="btn btn-primary">ایجاد</button>
					</div>
				</div>
				
			</form>
			
		</div>
		
	</div>
	
</div>
{% endfor %}
{% endblock contentpanel_dashboard %}

<script>
	document.querySelectorAll('[data-bs-target="#modal_category_edit"]').forEach(button => {
		button.addEventListener('click', function() {
			const categoryId = this.getAttribute('data-category-id');
			fetch(`/master/dashboard/category/get/${categoryId}/`)
				.then(response => response.json())
				.then(data => {
					document.getElementById('title_category_edit').value = data.title;
					document.getElementById('color_bg_category_edit').value = data.color;
					document.getElementById('color_text_category_edit').value = data.color_text;
					document.getElementById('edit_category_form').action = `/master/dashboard/category/edit/submit/${categoryId}/`;
				});
		});
	});
	
	document.getElementById('edit_category_form').addEventListener('submit', function(e) {
		e.preventDefault();
		const formData = new FormData(this);
		fetch(this.action, {
			method: 'POST',
			body: formData
		})
		.then(response => response.json())
		.then(data => {
			if (data.success) {
				// نمایش پیام موفقیت و بستن مودال
				alert(data.message);
				$('#modal_category_edit').modal('hide');
			} else {
				// نمایش پیام خطا
				alert(data.message);
			}
		});
	});
	</script>


{% block link_js %}

<script>
	
  </script>



<script src="{% static 'master/' %}js/sweetalert.js"></script>
<script src="{% static 'master/' %}js/delete_swal.js"></script>
<script src="{% static 'master/' %}js/ajax.js"></script>
<script src="{% static 'master/' %}js/ajax_tabel_category.js"></script>
<script src="{% static 'master/' %}js/ajax_tabel_subcategory.js"></script>


<script>
	document.querySelector(".upload-button").addEventListener("click", () => {
	 //clicks on the file input
	 document.querySelector(".hidden-upload").click();
   });
   //adds event listener on the hidden file input to listen for any changes
   document.querySelector(".hidden-upload").addEventListener("change", (event) => {
	 //gets the file name
	 document.querySelector(".upload-name").value = event.target.files[0].name;
   });
</script>

{% endblock link_js %}
